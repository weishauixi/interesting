<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>æƒ…ç»ªæ˜Ÿäº‘ - æŠ½è±¡äº¤äº’</title>
  <style>
    /* ========== å…¨å±€æ ·å¼ ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    /* ========== å®¹å™¨ ========== */
    .container {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
      background: #000;
    }

    /* ========== Canvasç”»å¸ƒ ========== */
    #particleCanvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none;
    }

    /* ========== æ–‡å­—ç²’å­å±‚ ========== */
    .text-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .text-particle {
      position: absolute;
      font-weight: 300;
      text-shadow: 0 0 10px currentColor;
      transition: opacity 0.3s ease;
      will-change: transform;
      white-space: nowrap;
    }

    /* ========== æ§åˆ¶æŒ‰é’® ========== */
    .controls {
      position: absolute;
      bottom: 30px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 10;
    }

    .btn-control {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 0;
      line-height: 1;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .btn-control:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .btn-control:active {
      transform: scale(0.95);
    }

    /* ========== æç¤ºæ–‡å­— ========== */
    .hint {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.3);
      font-size: 12px;
      letter-spacing: 3px;
      pointer-events: none;
      z-index: 10;
    }

    /* ========== å“åº”å¼ ========== */
    @media (max-width: 768px) {
      .controls {
        bottom: 20px;
        right: 20px;
        gap: 10px;
      }

      .btn-control {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .hint {
        bottom: 20px;
        font-size: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Canvasç”»å¸ƒ -->
    <canvas id="particleCanvas"></canvas>

    <!-- æ–‡å­—ç²’å­å±‚ -->
    <div class="text-layer" id="textLayer"></div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <button class="btn-control" id="btnMusic" title="éŸ³ä¹">ğŸµ</button>
      <button class="btn-control" id="btnSave" title="ä¿å­˜">ğŸ“·</button>
      <button class="btn-control" id="btnReset" title="é‡ç½®">ğŸ”„</button>
    </div>

    <!-- æç¤ºæ–‡å­— -->
    <div class="hint">è§¦æ‘¸Â·æ»‘åŠ¨Â·é•¿æŒ‰</div>
  </div>

  <script>
    // ========== æƒ…ç»ªæ˜Ÿäº‘ - æ ¸å¿ƒé€»è¾‘ ==========
    // ç²’å­ç³»ç»Ÿ | åŠ¨ç”»å¾ªç¯ | äº¤äº’äº‹ä»¶

    class EmotionNebula {
      constructor() {
        // Canvasè®¾ç½®
        this.canvas = document.getElementById('particleCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.textLayer = document.getElementById('textLayer');

        // ç²’å­æ•°ç»„
        this.particles = [];
        this.textParticles = [];

        // æŠ½è±¡æ–‡å­—ç´ æåº“
        this.textSources = [
          'æ¢¦', 'é›¾', 'å…‰', 'å½±', 'å°˜', 'é£', 'é›¨', 'é›ª',
          'æµé€', 'ç¢ç‰‡', 'è¤¶çš±', 'é£˜æµ®', 'æ²‰æ²¡', 'ç»½æ”¾',
          'âŒ˜', 'â”', 'âŠ', 'âˆ', 'â—‡', 'â—‹', 'â–³', 'â–¡',
          'éœé‚£', 'æ°¸æ’', 'è™šæ— ', 'å­˜åœ¨', 'æ··æ²Œ',
          'åƒé£ä¸€æ ·', 'æ—¶å…‰å€’æµ', 'æ˜Ÿäº‘ç ´ç¢', 'å¯‚é™å›å“'
        ];

        // é…è‰²æ–¹æ¡ˆ
        this.colorPalettes = [
          ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'],  // æ¸©æš–
          ['#A8E6CF', '#DCEDC1', '#FFD3B6', '#FFAAA5'],  // æŸ”å’Œ
          ['#667eea', '#764ba2', '#f093fb', '#4facfe'],  // æ¢¦å¹»
          ['#00d2ff', '#3a7bd5', '#00b4db', '#1e3c72'],  // å†·è°ƒ
        ];

        this.colors = [];
        this.textParticleId = 0;

        // éŸ³é¢‘
        this.audio = null;
        this.isPlayingMusic = false;

        // äº¤äº’çŠ¶æ€
        this.lastTouchPos = { x: 0, y: 0 };
        this.touchStartTime = 0;
        this.longPressTimer = null;

        // åˆå§‹åŒ–
        this.init();
      }

      init() {
        this.resize();
        this.initColors();
        this.initParticles();
        this.bindEvents();
        this.startAnimation();
        this.spawnTextParticles();

        // çª—å£å¤§å°æ”¹å˜
        window.addEventListener('resize', () => this.resize());
      }

      // ========== Canvasåˆå§‹åŒ– ==========
      resize() {
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width;
        this.canvas.height = this.height;
      }

      // ========== é¢œè‰²åˆå§‹åŒ– ==========
      initColors() {
        const palette = this.colorPalettes[
          Math.floor(Math.random() * this.colorPalettes.length)
        ];
        this.colors = [...palette];
      }

      // ========== ç²’å­ç³»ç»Ÿæ ¸å¿ƒ ==========
      /**
       * åˆ›å»ºç²’å­
       * @param {number} x - Xåæ ‡
       * @param {number} y - Yåæ ‡
       * @param {object} options - å¯é€‰å‚æ•°
       */
      createParticle(x, y, options = {}) {
        const shape = options.shape || ['circle', 'triangle', 'square'][
          Math.floor(Math.random() * 3)
        ];
        const size = options.size || Math.random() * 20 + 5;
        const color = options.color || this.colors[
          Math.floor(Math.random() * this.colors.length)
        ];

        return {
          x: x ?? Math.random() * this.width,
          y: y ?? Math.random() * this.height,
          vx: (Math.random() - 0.5) * 3,           // Xè½´é€Ÿåº¦
          vy: (Math.random() - 0.5) * 3,           // Yè½´é€Ÿåº¦
          size: size,
          targetSize: size,
          currentSize: 0,
          color: color,
          shape: shape,
          rotation: Math.random() * Math.PI * 2,   // æ—‹è½¬è§’åº¦
          rotationSpeed: (Math.random() - 0.5) * 0.1,
          life: 1,                                  // ç”Ÿå‘½å€¼
          decay: Math.random() * 0.002 + 0.0005,   // è¡°å‡é€Ÿåº¦
          alpha: Math.random() * 0.5 + 0.3,        // é€æ˜åº¦
          trail: [],                                // è½¨è¿¹
        };
      }

      /**
       * åˆå§‹åŒ–ç²’å­ç¾¤
       */
      initParticles() {
        const count = 50;
        for (let i = 0; i < count; i++) {
          this.particles.push(this.createParticle());
        }
      }

      /**
       * æ›´æ–°ç²’å­çŠ¶æ€
       */
      updateParticles() {
        this.particles = this.particles.filter(p => {
          // æ›´æ–°ä½ç½®
          p.x += p.vx;
          p.y += p.vy;

          // è¾¹ç•Œåå¼¹
          if (p.x < 0 || p.x > this.width) p.vx *= -0.8;
          if (p.y < 0 || p.y > this.height) p.vy *= -0.8;

          // æ—‹è½¬æ›´æ–°
          p.rotation += p.rotationSpeed;

          // æ¸å…¥æ•ˆæœ
          if (p.currentSize < p.targetSize) {
            p.currentSize += 0.5;
          }

          // è®°å½•è½¨è¿¹
          p.trail.push({ x: p.x, y: p.y });
          if (p.trail.length > 20) p.trail.shift();

          // ç”Ÿå‘½è¡°å‡
          p.life -= p.decay;

          return p.life > 0;
        });

        // ç»´æŒæœ€å°ç²’å­æ•°
        while (this.particles.length < 30) {
          this.particles.push(this.createParticle());
        }
      }

      /**
       * ç»˜åˆ¶ç²’å­
       */
      drawParticles() {
        const ctx = this.ctx;

        // åŠé€æ˜èƒŒæ™¯å®ç°æ‹–å°¾æ•ˆæœ
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, this.width, this.height);

        this.particles.forEach(p => {
          ctx.save();
          ctx.globalAlpha = p.alpha * p.life;
          ctx.fillStyle = p.color;

          // ç»˜åˆ¶è½¨è¿¹
          if (p.trail.length > 1) {
            ctx.beginPath();
            ctx.moveTo(p.trail[0].x, p.trail[0].y);
            p.trail.forEach(point => {
              ctx.lineTo(point.x, point.y);
            });
            ctx.strokeStyle = p.color;
            ctx.lineWidth = p.size * 0.3;
            ctx.globalAlpha = p.alpha * p.life * 0.3;
            ctx.stroke();
          }

          // ç»˜åˆ¶ç²’å­
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation);
          ctx.globalAlpha = p.alpha * p.life;

          switch (p.shape) {
            case 'circle':
              ctx.beginPath();
              ctx.arc(0, 0, p.currentSize, 0, Math.PI * 2);
              ctx.fill();
              break;

            case 'triangle':
              ctx.beginPath();
              ctx.moveTo(0, -p.currentSize);
              ctx.lineTo(p.currentSize * 0.866, p.currentSize * 0.5);
              ctx.lineTo(-p.currentSize * 0.866, p.currentSize * 0.5);
              ctx.closePath();
              ctx.fill();
              break;

            case 'square':
              ctx.fillRect(
                -p.currentSize / 2,
                -p.currentSize / 2,
                p.currentSize,
                p.currentSize
              );
              break;
          }

          ctx.restore();
        });
      }

      /**
       * ç²’å­åˆ†è£‚ - è§¦æ‘¸æ—¶è§¦å‘
       */
      splitParticles(x, y) {
        const splitCount = 8;
        for (let i = 0; i < splitCount; i++) {
          const angle = (Math.PI * 2 / splitCount) * i;
          const speed = Math.random() * 4 + 2;
          const particle = this.createParticle(x, y, {
            size: Math.random() * 15 + 5,
            color: this.colors[Math.floor(Math.random() * this.colors.length)]
          });
          particle.vx = Math.cos(angle) * speed;
          particle.vy = Math.sin(angle) * speed;
          particle.decay = 0.01;
          this.particles.push(particle);
        }

        // éœ‡åŠ¨åé¦ˆï¼ˆæ”¯æŒçš„è®¾å¤‡ï¼‰
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      }

      // ========== åŠ¨ç”»å¾ªç¯ ==========
      startAnimation() {
        const animate = () => {
          this.updateParticles();
          this.drawParticles();
          this.updateTextParticles();
          requestAnimationFrame(animate);
        };
        animate();
      }

      // ========== æ–‡å­—ç²’å­ç³»ç»Ÿ ==========
      spawnTextParticles() {
        setInterval(() => {
          if (this.textParticles.length < 8) {
            const text = this.textSources[
              Math.floor(Math.random() * this.textSources.length)
            ];
            const color = this.colors[
              Math.floor(Math.random() * this.colors.length)
            ];

            const textParticle = {
              id: this.textParticleId++,
              text: text,
              x: Math.random() * (this.width - 100) + 50,
              y: Math.random() * (this.height - 100) + 50,
              vx: (Math.random() - 0.5) * 1,
              vy: (Math.random() - 0.5) * 1,
              color: color,
              size: Math.random() * 20 + 14,
              opacity: 0,
              targetOpacity: Math.random() * 0.6 + 0.4,
            };

            this.textParticles.push(textParticle);
            this.createTextElement(textParticle);
          }
        }, 3000);
      }

      createTextElement(particle) {
        const el = document.createElement('div');
        el.className = 'text-particle';
        el.id = `text-${particle.id}`;
        el.textContent = particle.text;
        el.style.color = particle.color;
        el.style.fontSize = `${particle.size}px`;
        this.textLayer.appendChild(el);
      }

      updateTextParticles() {
        this.textParticles = this.textParticles.filter(p => {
          p.x += p.vx;
          p.y += p.vy;

          // è¾¹ç•Œæ£€æµ‹
          if (p.x < 0 || p.x > this.width) p.vx *= -1;
          if (p.y < 0 || p.y > this.height) p.vy *= -1;

          // æ¸å…¥æ•ˆæœ
          if (p.opacity < p.targetOpacity) {
            p.opacity = Math.min(p.opacity + 0.02, p.targetOpacity);
          }

          // æ›´æ–°DOM
          const el = document.getElementById(`text-${p.id}`);
          if (el) {
            el.style.left = `${p.x}px`;
            el.style.top = `${p.y}px`;
            el.style.opacity = p.opacity;
          }

          return true;
        });
      }

      // ========== äº¤äº’äº‹ä»¶ç»‘å®š ==========
      bindEvents() {
        const canvas = this.canvas;

        // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯ï¼‰
        canvas.addEventListener('touchstart', (e) => this.onTouchStart(e), { passive: false });
        canvas.addEventListener('touchmove', (e) => this.onTouchMove(e), { passive: false });
        canvas.addEventListener('touchend', () => this.onTouchEnd());

        // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
        canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
        canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
        canvas.addEventListener('mouseup', () => this.onMouseEnd());

        // æŒ‰é’®äº‹ä»¶
        document.getElementById('btnMusic').addEventListener('click', () => this.toggleMusic());
        document.getElementById('btnSave').addEventListener('click', () => this.saveImage());
        document.getElementById('btnReset').addEventListener('click', () => this.resetCanvas());
      }

      getEventPos(e) {
        if (e.touches) {
          return { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
        return { x: e.clientX, y: e.clientY };
      }

      // è§¦æ‘¸äº‹ä»¶
      onTouchStart(e) {
        e.preventDefault();
        const pos = this.getEventPos(e);
        this.lastTouchPos = pos;
        this.touchStartTime = Date.now();

        this.splitParticles(pos.x, pos.y);

        // é•¿æŒ‰æ£€æµ‹
        this.longPressTimer = setTimeout(() => {
          this.saveImage();
        }, 800);
      }

      onTouchMove(e) {
        e.preventDefault();
        const pos = this.getEventPos(e);
        const dx = pos.x - this.lastTouchPos.x;
        const dy = pos.y - this.lastTouchPos.y;

        // å½±å“é™„è¿‘ç²’å­
        this.particles.forEach(p => {
          const dist = Math.hypot(p.x - pos.x, p.y - pos.y);
          if (dist < 150) {
            p.vx += dx * 0.02;
            p.vy += dy * 0.02;
          }
        });

        this.lastTouchPos = pos;
      }

      onTouchEnd() {
        if (this.longPressTimer) {
          clearTimeout(this.longPressTimer);
          this.longPressTimer = null;
        }
      }

      // é¼ æ ‡äº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
      onMouseDown(e) {
        const pos = { x: e.clientX, y: e.clientY };
        this.lastTouchPos = pos;
        this.splitParticles(pos.x, pos.y);
      }

      onMouseMove(e) {
        if (e.buttons === 1) {
          const pos = { x: e.clientX, y: e.clientY };
          const dx = pos.x - this.lastTouchPos.x;
          const dy = pos.y - this.lastTouchPos.y;

          this.particles.forEach(p => {
            const dist = Math.hypot(p.x - pos.x, p.y - pos.y);
            if (dist < 150) {
              p.vx += dx * 0.02;
              p.vy += dy * 0.02;
            }
          });

          this.lastTouchPos = pos;
        }
      }

      onMouseEnd() {}

      // ========== æ§åˆ¶åŠŸèƒ½ ==========
      toggleMusic() {
        if (!this.audio) {
          // åˆ›å»ºéŸ³é¢‘
          this.audio = new Audio();
          this.audio.loop = true;
          this.audio.volume = 0.3;

          // ä½¿ç”¨å…è´¹çš„ç¯å¢ƒéŸ³ä¹èµ„æº
          this.audio.src = 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3';

          this.audio.play().then(() => {
            this.isPlayingMusic = true;
            document.getElementById('btnMusic').textContent = 'â¸';
          }).catch(err => {
            console.log('éŸ³é¢‘æ’­æ”¾éœ€è¦ç”¨æˆ·äº¤äº’');
          });
        } else {
          if (this.isPlayingMusic) {
            this.audio.pause();
            this.isPlayingMusic = false;
            document.getElementById('btnMusic').textContent = 'ğŸµ';
          } else {
            this.audio.play();
            this.isPlayingMusic = true;
            document.getElementById('btnMusic').textContent = 'â¸';
          }
        }

        if (navigator.vibrate) {
          navigator.vibrate(30);
        }
      }

      saveImage() {
        if (this.longPressTimer) {
          clearTimeout(this.longPressTimer);
          this.longPressTimer = null;
        }

        if (navigator.vibrate) {
          navigator.vibrate([50, 50, 50]);
        }

        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.download = `æƒ…ç»ªæ˜Ÿäº‘_${Date.now()}.png`;
        link.href = this.canvas.toDataURL('image/png');
        link.click();

        // æ˜¾ç¤ºæç¤º
        this.showToast('å›¾ç‰‡å·²ä¿å­˜');
      }

      resetCanvas() {
        if (navigator.vibrate) {
          navigator.vibrate([30, 30]);
        }

        // æ¸…é™¤ç²’å­
        this.particles = [];
        this.textParticles = [];
        this.textLayer.innerHTML = '';

        // é‡æ–°åˆå§‹åŒ–
        this.initColors();
        this.initParticles();

        // æ¸…ç©ºç”»å¸ƒ
        this.ctx.fillStyle = '#000';
        this.ctx.fillRect(0, 0, this.width, this.height);

        this.showToast('å·²é‡ç½®');
      }

      showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 255, 255, 0.9);
          color: #000;
          padding: 15px 30px;
          border-radius: 25px;
          font-size: 14px;
          z-index: 1000;
          animation: fadeInOut 2s ease;
        `;
        document.body.appendChild(toast);

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        if (!document.getElementById('toastStyle')) {
          const style = document.createElement('style');
          style.id = 'toastStyle';
          style.textContent = `
            @keyframes fadeInOut {
              0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
              20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
              80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
              100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            }
          `;
          document.head.appendChild(style);
        }

        setTimeout(() => toast.remove(), 2000);
      }
    }

    // ========== å¯åŠ¨åº”ç”¨ ==========
    window.addEventListener('DOMContentLoaded', () => {
      new EmotionNebula();
    });
  </script>
</body>
</html>
